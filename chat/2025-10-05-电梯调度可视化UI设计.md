# 电梯调度可视化Web UI设计方案

**日期**: 2025-10-05
**议题**: 设计清晰直观的Web浏览器界面来展示电梯调度过程

---

## 需求分析

当前simple_example.py只输出文本日志，难以直观理解：
- 每个等待乘客的起点和终点
- 哪些乘客上了哪部电梯
- 电梯内乘客的目的地
- 整体调度效果

需要设计一个在**浏览器中显示的美观可视化界面**来展示所有信息。

---

## UI设计方案 v2.0 (Web版)

### 整体布局（浏览器页面）

```
┌─────────────────────────────────────────────────────────────────┐
│  🏢 电梯调度可视化系统                    Tick: 120  ⏸️ ▶️ ⏩  │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ┌──────────┬──────────┬──────────┬──────────┐                 │
│  │          │  电梯 1  │  电梯 2  │  电梯 3  │                 │
│  │   F5     │          │          │  ┌────┐  │  等待: 👤👤     │
│  │          │          │          │  │ ↓  │  │  P03→F2        │
│  │          │          │          │  │👤👤│  │  P07→F0        │
│  ├──────────┼──────────┼──────────┼──┴────┴──┤                 │
│  │   F4     │          │  ┌────┐  │          │  等待: 👤👤👤   │
│  │          │          │  │ ↑  │  │          │  ↑ P01→F7      │
│  │          │          │  │👤👤│  │          │  ↑ P05→F6      │
│  │          │          │  │👤  │  │          │  ↓ P08→F1      │
│  ├──────────┼──────────┼──┴────┴──┼──────────┤                 │
│  │   F3     │          │          │          │                 │
│  │          │    │     │    │     │    │     │                 │
│  ├──────────┼────┼─────┼────┼─────┼────┼─────┤                 │
│  │   F2     │  ┌─┴──┐  │          │          │  等待: 👤👤     │
│  │          │  │ ↑  │  │          │          │  ↑ P02→F5      │
│  │          │  │👤👤│  │          │          │  ↓ P06→F0      │
│  ├──────────┼──┴────┴──┼──────────┼──────────┤                 │
│  │   F1     │          │          │          │                 │
│  │          │    │     │    │     │    │     │                 │
│  ├──────────┼────┼─────┼────┼─────┼────┼─────┤                 │
│  │   F0     │    ↓     │    ↓     │    ↓     │  等待: 👤👤👤   │
│  │          │          │          │          │  ↑ P13→F3      │
│  │          │          │          │          │  ↑ P14→F5      │
│  └──────────┴──────────┴──────────┴──────────┘                 │
│                                                                   │
│  ┌─────────────────────  统计面板  ──────────────────────┐      │
│  │ 📊 总乘客: 15  ✅ 已送达: 0  🚀 运送中: 3  ⏳ 等待: 12 │      │
│  │ ⏱️  平均等待: 45 ticks  |  平均运送: 23 ticks         │      │
│  └──────────────────────────────────────────────────────┘      │
│                                                                   │
│  ┌─────────────────────  事件日志  ──────────────────────┐      │
│  │ [Tick 120] 电梯E1到达F2                                │      │
│  │ [Tick 119] 乘客P04登上电梯E1，目标F6                   │      │
│  │ [Tick 118] 乘客P10登上电梯E1，目标F8                   │      │
│  │ ...                                                     │      │
│  └──────────────────────────────────────────────────────┘      │
└─────────────────────────────────────────────────────────────────┘
```

### 视觉设计要点

#### 1. **楼层区域**（左侧主区域）
- 每层楼一行，从上到下排列（F5在上，F0在下）
- 每部电梯一列垂直通道
- 电梯轿厢：
  - 矩形方框表示电梯
  - 内部显示方向箭头：`↑` 上行 / `↓` 下行 / `◆` 空闲
  - 显示电梯内乘客图标 `👤`
  - 悬停显示详细信息（乘客ID和目的地）
- 电梯轨道：
  - 电梯不在该楼层时显示竖线 `│` 或虚线
  - 表示电梯通道

#### 2. **等待队列区域**（右侧）
- 每层楼显示等待的乘客
- 使用人形图标 `👤`
- 显示方向和目的地：`↑ P01→F7`
- 按先来后到顺序排列
- 等待时间过长用红色高亮

#### 3. **控制按钮**（顶部右侧）
- ⏸️ 暂停
- ▶️ 播放/继续
- ⏩ 快进
- ⏪ 后退（如果支持历史回放）
- 速度滑块

#### 4. **统计面板**（底部）
- 使用图标和数字
- 关键指标一目了然
- 可以使用颜色区分不同状态

#### 5. **事件日志**（最底部，可折叠）
- 显示最近的事件
- 可滚动查看历史
- 可选择是否显示

### 颜色方案

- **电梯状态**：
  - 🟢 绿色：空闲
  - 🔵 蓝色：上行
  - 🟠 橙色：下行
  - 🟣 紫色：开门中

- **乘客状态**：
  - 🟡 黄色：等待中
  - 🔴 红色：等待过久（超过阈值）
  - 🟢 绿色：已送达

- **背景**：
  - 浅灰色主背景
  - 白色卡片区域
  - 楼层之间有分隔线

---

## 实现技术选型

### 方案1: 纯HTML + CSS + JavaScript
- 前端：HTML/CSS/JavaScript
- 后端：Python FastAPI提供WebSocket接口
- 通信：WebSocket实时推送状态更新
- 优点：轻量，无额外依赖
- 缺点：需要手写较多代码

### 方案2: Vue.js + FastAPI
- 前端：Vue.js 框架
- 后端：FastAPI + WebSocket
- 优点：组件化，易维护
- 缺点：需要学习Vue

### 方案3: React + FastAPI
- 前端：React 框架
- 后端：FastAPI + WebSocket
- 优点：生态强大
- 缺点：配置复杂

### 方案4: Streamlit（最简单）
- 使用Streamlit框架
- 纯Python开发
- 优点：极简，快速开发
- 缺点：定制化受限，性能一般

**推荐方案1**：纯HTML+CSS+JS，轻量且灵活，适合本项目规模。

---

## 架构设计

```
┌─────────────────┐         WebSocket          ┌──────────────────┐
│   浏览器客户端   │ ←─────────────────────────→ │  Python后端      │
│  (HTML/CSS/JS)  │                             │  (FastAPI)       │
│                 │   实时推送电梯状态           │                  │
│  - 渲染UI       │ ←─────────────────────────  │  - 电梯控制器    │
│  - 接收更新     │                             │  - 状态管理      │
│  - 发送控制命令 │  ─────────────────────────→ │  - 事件处理      │
└─────────────────┘   (暂停/继续/速度)          └──────────────────┘
```

### 数据流

1. **初始化**：
   - 浏览器连接到WebSocket
   - 后端发送初始状态（楼层数、电梯数）

2. **实时更新**：
   - 每个Tick后，后端推送状态更新：
     ```json
     {
       "tick": 120,
       "elevators": [
         {
           "id": 1,
           "floor": 2.5,
           "direction": "up",
           "passengers": [
             {"id": "P04", "destination": 6},
             {"id": "P10", "destination": 8}
           ]
         }
       ],
       "floors": [
         {
           "floor": 0,
           "waiting_up": [
             {"id": "P13", "destination": 3, "wait_time": 45}
           ],
           "waiting_down": []
         }
       ],
       "stats": {
         "total": 15,
         "delivered": 0,
         "in_transit": 3,
         "waiting": 12
       }
     }
     ```

3. **控制命令**：
   - 前端发送控制命令（暂停/继续/速度调整）
   - 后端响应并调整模拟速度

---

## 待讨论问题

1. **动画效果**
   - 电梯移动是否需要平滑动画？
   - 还是直接跳到新位置？
   - 动画可能使调试更直观，但增加复杂度
   答：编码中电梯是消耗tick移动的，在ui中我们需要放慢每一个tick的速度，看到电梯移动过程（当然这个速度我需要在配置文件中全局可调、可回归最开始的tick）

2. **实时性 vs 批量更新**
   - 每个事件立即推送？（实时性强但流量大）
   - 每个Tick统一推送？（平衡性能和实时性）
   - 固定时间间隔推送？（可控流量）
   答：可以先终端跑完，然后再根据整个过程推送到ui中，让我们看慢速过程。

3. **历史回放功能**
   - 是否需要记录历史状态，支持回放？
   - 这对调试算法很有帮助
   答：需要！最好能建一个文件夹，把每次结果详细保存好

4. **响应式设计**
   - 是否需要支持移动端？
   - 电梯和楼层数量较多时如何布局？
   答：不需要。电梯是固定的2台，请查看代码，电梯端的代码我们是不能改变的。

5. **多实例支持**
   - 是否允许多个浏览器同时查看？
   - 是否支持同时运行多个模拟实例？
   答：不需要。

---

## 文件结构建议

```
elevator_saga/
├── client_examples/
│   ├── simple_example.py          # 现有的简单示例
│   └── visual_example.py          # 新的可视化示例（继承simple_example）
├── visualization/
│   ├── __init__.py
│   ├── web_server.py              # FastAPI WebSocket服务器
│   ├── static/
│   │   ├── index.html             # 主页面
│   │   ├── style.css              # 样式
│   │   └── app.js                 # 前端逻辑
│   └── templates/                 # （如果需要）
```

---

## 下一步行动

1. ✅ 确认采用Web UI方案
2. ✅ 确认技术选型和设计细节
3. ✅ 实现WebSocket服务器
4. ✅ 实现前端可视化界面
5. ✅ 集成到电梯控制器
6. 🔄 测试和优化

---

## 最终实现方案

### 已完成的工作

1. **可视化控制器** (`visual_example.py`)
   - 继承自 `simple_example.py` 的 `ElevatorBusController`
   - 在每个tick记录完整状态快照
   - 自动保存到JSON文件（带时间戳）
   - 文件保存在 `elevator_saga/visualization/recordings/` 目录

2. **WebSocket服务器** (`web_server.py`)
   - 基于FastAPI和WebSocket
   - 提供记录文件列表API
   - 通过WebSocket推送历史数据
   - 托管静态前端文件

3. **前端界面** (`static/index.html`, `style.css`, `app.js`)
   - 美观的渐变背景和卡片设计
   - 楼层垂直布局（顶楼在上）
   - 电梯实时位置显示
   - 等待队列详细信息
   - 播放控制（播放/暂停/重置/速度/进度）
   - 统计面板和事件日志

### 使用流程

1. 运行模拟: `python -m elevator_saga.client_examples.visual_example`
2. 启动服务器: `python -m elevator_saga.visualization.web_server`
3. 浏览器访问: http://127.0.0.1:8080
4. 选择记录文件并播放

### 技术特点

- **离线回放模式**: 先运行后播放，避免实时性能问题
- **可调速度**: 0.1x ~ 5.0x，满足调试需求
- **历史记录**: 所有模拟自动保存，可随时回看
- **清晰展示**: 一眼看出每个乘客的起点、终点和当前状态
- **模块独立**: 不修改原有代码，通过继承扩展功能
